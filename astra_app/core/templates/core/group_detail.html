{% extends 'core/base.html' %}

{% load core_user_grid %}
{% load core_user_widget %}
{% load core_group_widget %}
{% load core_chatnickname %}

{% block title %}Group {{ group.cn }}{% endblock %}

{% block header %}
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h1 class="m-0">
      Group: {{ group.cn }}
      <small class="text-muted">({{ member_count }} members)</small>
    </h1>

    {% if is_member %}
      <button type="button" class="btn btn-outline-danger" data-toggle="modal" data-target="#leave-group-modal">
        Leave group
      </button>
    {% endif %}
  </div>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="{% if is_sponsor %}col-lg-8{% else %}col-lg-12{% endif %}">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center" style="gap: .5rem;">
            <h3 class="card-title mb-0">Group info</h3>
            {% if is_sponsor %}
              <a class="btn btn-sm btn-outline-primary" href="{% url 'group-edit' group.cn %}">
                <i class="fas fa-edit mr-1"></i> Edit group
              </a>
            {% endif %}
          </div>
        </div>
        <ul class="list-group list-group-flush">
          {% if group.description %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong class="profile-attr-label mr-2" title="Description"><i class="fas fa-align-left"></i> Description</strong>
              <div class="profile-attr-value text-end">{{ group.description }}</div>
            </li>
          {% endif %}

          {% if group.fas_url %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong class="profile-attr-label" title="URL"><i class="fas fa-link"></i> URL</strong>
              <div class="profile-attr-value text-end"><a href="{{ group.fas_url }}" rel="noopener" target="_blank">{{ group.fas_url }}</a></div>
            </li>
          {% endif %}

          {% if group.fas_mailing_list %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong class="profile-attr-label" title="Mailing list"><i class="fas fa-envelope"></i> Mailing list</strong>
              <div class="profile-attr-value text-end"><a href="mailto:{{ group.fas_mailing_list }}">{{ group.fas_mailing_list }}</a></div>
            </li>
          {% endif %}

          {% if group.fas_irc_channels %}
            <li class="list-group-item d-flex justify-content-between">
              <strong class="profile-attr-label" title="Chat channels"><i class="fas fa-comments"></i> Chat</strong>
              <div class="profile-attr-value text-end">
                {% for ch in group.fas_irc_channels %}
                  <div class="mb-0 text-monospace">{{ ch|channel }}</div>
                {% endfor %}
              </div>
            </li>
          {% endif %}

          {% if group.fas_discussion_url %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong class="profile-attr-label" title="Discussion URL"><i class="far fa-comment-dots"></i> Discussion</strong>
              <div class="profile-attr-value text-end"><a href="{{ group.fas_discussion_url }}" rel="noopener" target="_blank">{{ group.fas_discussion_url }}</a></div>
            </li>
          {% endif %}

          {% if required_agreements %}
            <li class="list-group-item d-flex justify-content-between">
              <strong class="profile-attr-label" title="Required agreements"><i class="fas fa-file-signature"></i> Agreements</strong>
              <div class="profile-attr-value text-end">
                {% for a in required_agreements %}
                  {% if a.signed %}
                    <div class="mb-1"><span class="badge badge-success">{{ a.cn }} (Signed)</span></div>
                  {% else %}
                    <div class="mb-1"><a class="badge badge-warning" href="{{ a.detail_url }}">{{ a.cn }} (Unsigned)</a></div>
                  {% endif %}
                {% endfor %}
                <div class="small text-muted mt-1">
                  Sign agreements in <a href="{% url 'settings-agreements' %}">Settings â†’ Agreements</a>.
                </div>
              </div>
            </li>
          {% endif %}

          {% if not group.description and not group.fas_url and not group.fas_mailing_list and not group.fas_irc_channels and not group.fas_discussion_url and not required_agreements %}
            <li class="list-group-item text-muted text-center py-4">No group info available.</li>
          {% endif %}
        </ul>
      </div>
    </div>

    {% if is_sponsor %}
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Sponsor tools</h3>
          </div>
          <div class="card-body">
            <form method="post" class="mb-2">
              {% csrf_token %}
              <input type="hidden" name="action" value="add_member" />
              <div class="input-group">
                <input
                  id="sponsor-add-username"
                  type="text"
                  name="username"
                  class="form-control"
                  placeholder="Add member by username"
                  list="sponsor-user-suggestions"
                  autocomplete="off"
                />
                <button class="btn btn-primary" type="submit">Add</button>
              </div>
            </form>

            <datalist id="sponsor-user-suggestions"></datalist>

            <button
              type="button"
              class="btn btn-outline-secondary btn-sm w-100"
              data-toggle="modal"
              data-target="#stop-sponsoring-modal"
            >Stop being a sponsor</button>

            <small class="text-muted d-block mt-2">
              Users must have signed required agreements before being added.
            </small>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  {% if sponsor_groups_list or sponsors_list %}
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Sponsors</h3>
      </div>
      <div class="card-body">
        <div class="row">
          {% for cn in sponsor_groups_list %}
            <div class="col-12 col-md-6 col-lg-4 col-xl-3">
              {% group cn %}
            </div>
          {% endfor %}

          {% for username in sponsors_list %}
            <div class="col-12 col-md-6 col-lg-4 col-xl-3">
              {% if unsigned_usernames and username in unsigned_usernames %}
                {% user username class="text-muted" style="opacity:0.55;" %}
              {% else %}
                {% user username %}
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Members</h3>
      <div class="card-tools">
        <form method="get" class="input-group input-group-sm" style="width: 220px;">
          <input
            type="text"
            name="q"
            class="form-control float-right"
            placeholder="Search"
            value="{{ q }}"
            aria-label="Search members"
          >
          <div class="input-group-append">
            {% if q %}
              <button
                type="button"
                class="btn btn-default"
                aria-label="Clear search"
                onclick="var i=this.form.querySelector('input[name=\'q\']'); if(i){i.value='';} this.form.submit();"
              >
                <i class="fas fa-times"></i>
              </button>
            {% endif %}
            <button type="submit" class="btn btn-default" aria-label="Search">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card-body">
      {% user_grid group=group member_manage_enabled=is_sponsor member_manage_group_cn=group.cn muted_usernames=unsigned_usernames %}
    </div>
  </div>

  <script>
    (function () {
      const input = document.getElementById('sponsor-add-username');
      const list = document.getElementById('sponsor-user-suggestions');
      if (!input || !list) return;

      let timer = null;
      let lastQuery = '';
      let inflight = null;

      function clearOptions() {
        list.innerHTML = '';
      }

      function setOptions(usernames) {
        clearOptions();
        for (const u of usernames) {
          const opt = document.createElement('option');
          opt.value = u;
          list.appendChild(opt);
        }
      }

      async function fetchSuggestions(q) {
        if (!q) {
          clearOptions();
          return;
        }

        lastQuery = q;
        if (inflight && typeof inflight.abort === 'function') {
          inflight.abort();
        }
        inflight = new AbortController();

        try {
          const resp = await fetch('/search/?q=' + encodeURIComponent(q), {
            headers: { 'Accept': 'application/json' },
            signal: inflight.signal,
          });
          if (!resp.ok) return;
          const data = await resp.json();
          if (q !== lastQuery) return;
          const users = Array.isArray(data.users) ? data.users : [];
          const usernames = users
            .map((x) => (x && x.username ? String(x.username) : ''))
            .filter((x) => x)
            .slice(0, 12);
          setOptions(usernames);
        } catch (e) {
          if (e && e.name === 'AbortError') return;
        }
      }

      input.addEventListener('input', function () {
        const q = (input.value || '').trim();
        if (timer) window.clearTimeout(timer);
        timer = window.setTimeout(function () { fetchSuggestions(q); }, 180);
      });
    })();
  </script>

  {% if is_member %}
    {% include "core/_modal_confirm.html" with modal_id="leave-group-modal" title="Leave group?" body="Leave this group?" action_url="" submit_label="Leave group" submit_class="btn-danger" form_fields_template="core/_modal_confirm_fields.html" confirm_action="leave" %}
  {% endif %}

  {% if is_sponsor %}
    {% include "core/_modal_confirm.html" with modal_id="stop-sponsoring-modal" title="Stop being a sponsor?" body="Stop being a sponsor of this group?" action_url="" submit_label="Stop sponsoring" submit_class="btn-warning" form_fields_template="core/_modal_confirm_fields.html" confirm_action="stop_sponsoring" %}

    {% url "group-detail" group.cn as group_detail_url %}
    {% include "core/_modal_confirm.html" with modal_id="remove-member-modal" title="Remove member?" body_prefix="Remove " body_emphasis="" body_suffix=" from this group?" action_url=group_detail_url submit_label="Remove" submit_class="btn-danger" form_fields_template="core/_modal_confirm_fields.html" confirm_action="remove_member" confirm_username_field=True %}

    <script>
      (function () {
        var jq = window.jQuery;
        if (!jq || !jq.fn) return;

        jq('#remove-member-modal').on('show.bs.modal', function (evt) {
          var btn = evt && evt.relatedTarget ? evt.relatedTarget : null;
          var username = btn ? String(btn.getAttribute('data-username') || '') : '';

          var modalEl = this;
          var userEl = modalEl.querySelector('.js-confirm-username');
          if (userEl) userEl.value = username;

          var strongEl = modalEl.querySelector('.modal-body strong');
          if (strongEl) strongEl.textContent = username;
        });
      })();
    </script>
  {% endif %}
{% endblock %}
