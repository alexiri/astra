{% extends 'core/base.html' %}

{% load avatar_tags %}
{% load core_chatnickname %}
{% load core_membership_notes %}
{% load tz %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="profile-page">
  {% if is_self and email_is_blacklisted %}
    <div class="alert alert-danger" id="email-blacklisted-alert" role="alert">
      <strong>Email delivery problem:</strong>
      Your email address{% if fu.email %} (<a class="text-reset" href="mailto:{{ fu.email }}">{{ fu.email }}</a>){% endif %} has been blacklisted due to mail delivery issues.
      Please <a href="{% url 'settings-emails' %}" class="alert-link">set a new email address</a>.
    </div>
  {% endif %}

  {% if is_self and country_code_missing_or_invalid %}
    <div class="alert alert-danger" id="country-code-missing-alert" role="alert">
      <strong>Action required:</strong>
      Your profile is missing a valid <em>country code</em>. For legal reasons, all users must have a valid ISO 3166-1 alpha-2 country code on file.
      Please <a href="{% url 'settings-address' %}" class="alert-link">set your country code</a>.
    </div>
  {% endif %}

  {% if is_self and membership_action_required_requests %}
    <div class="alert alert-danger" id="membership-action-required-alert" role="alert">
      <strong>Action required:</strong>
      To complete your membership request, please
      <a
        href="{% url 'membership-request-self' membership_action_required_requests.0.request_id %}"
        class="alert-link"
      >provide the requested information</a>.
    </div>
  {% endif %}

  <div class="row">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <div class="d-none d-md-block">
            {% if profile_avatar_user.email %}
              {% avatar profile_avatar_user 220 class="img-fluid img-circle mb-3" style="width:220px;height:220px;object-fit:cover;" alt="Avatar" %}
            {% else %}
              <i class="far fa-user" style="font-size:140px;"></i>
            {% endif %}
          </div>
          <div class="d-md-none">
            {% if profile_avatar_user.email %}
              {% avatar profile_avatar_user 140 class="img-fluid img-circle mb-3" style="width:140px;height:140px;object-fit:cover;" alt="Avatar" %}
            {% else %}
              <i class="far fa-user" style="font-size:90px;"></i>
            {% endif %}
          </div>

          <h3 class="profile-username mb-1">{{ fu.get_full_name }}</h3>
          <div class="text-muted" id="user_username">{{ fu.username }}</div>
          {% if fu.email %}
            <div class="mt-1" id="user_mail"><a href="mailto:{{ fu.email }}">{{ fu.email }}</a></div>
          {% endif %}

          {% if is_self %}
            <div class="mt-3">
              <a class="btn btn-primary btn-block" href="{% url 'settings-profile' %}">Edit Profile</a>
            </div>
          {% endif %}
        </div>

        <ul class="list-group list-group-flush" id="user_attributes">
          {% if pronouns %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong class="profile-attr-label" title="Pronouns"><i class="fas fa-user-tag"></i> Pronouns</strong>
              <div class="profile-attr-value text-end">{{ pronouns }}</div>
            </li>
          {% endif %}

          {% if locale %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong class="profile-attr-label" title="Locale"><i class="fas fa-language"></i> Locale</strong>
              <div class="profile-attr-value text-end">{{ locale }}</div>
            </li>
          {% endif %}

          {% if timezone_name %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong class="profile-attr-label" title="Timezone"><i class="fas fa-globe"></i> Timezone</strong>
              <div class="profile-attr-value text-end">{{ timezone_name }}</div>
            </li>
            <li class="list-group-item" id="user-timezone" data-timezone="{{ timezone_name }}">
              <div class="d-flex justify-content-between align-items-center">
                <strong class="profile-attr-label" title="Current Time"><i class="far fa-clock"></i> Current Time</strong>
                <div class="profile-attr-value text-end" id="user-time">{{ current_time|date:"l H:i:s" }}</div>
              </div>
            </li>
          {% endif %}

          {% if irc_nicks %}
            <li class="list-group-item d-flex justify-content-between">
              <strong class="profile-attr-label" title="Chat"><i class="fas fa-comments"></i> Chat</strong>
              <div class="profile-attr-value text-end">
                {% for nick in irc_nicks %}
                  <div class="mb-0 text-monospace profile-chat-item">{{ nick|nickname }}</div>
                {% endfor %}
              </div>
            </li>
          {% endif %}

          {% if website_urls %}
            <li class="list-group-item d-flex justify-content-between">
              <strong class="profile-attr-label" title="Blog URL"><i class="fas fa-link"></i> Blog</strong>
              <div class="profile-attr-value text-end">
                {% for url in website_urls %}
                  <div class="mb-0 text-monospace"><a href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ url }}</a></div>
                {% endfor %}
              </div>
            </li>
          {% endif %}

          {% if rss_urls %}
            <li class="list-group-item d-flex justify-content-between">
              <strong class="profile-attr-label" title="RSS URL"><i class="fas fa-rss"></i> RSS</strong>
              <div class="profile-attr-value text-end">
                {% for url in rss_urls %}
                  <div class="mb-0 text-monospace"><a href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ url }}</a></div>
                {% endfor %}
              </div>
            </li>
          {% endif %}

          {% if rhbz_email %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong class="profile-attr-label" title="RHBZ"><i class="fas fa-bug"></i> RHBZ</strong>
              <div class="profile-attr-value text-end">{{ rhbz_email }}</div>
            </li>
          {% endif %}

          {% if github_username %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong class="profile-attr-label" title="GitHub"><i class="fab fa-github"></i> GitHub</strong>
              <div class="profile-attr-value text-end">
                <a href="https://github.com/{{ github_username }}" target="_blank" rel="noopener noreferrer">@{{ github_username }}</a>
              </div>
            </li>
          {% endif %}

          {% if gitlab_username %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <strong class="profile-attr-label" title="GitLab"><i class="fab fa-gitlab"></i> GitLab</strong>
              <div class="profile-attr-value text-end">
                <a href="https://gitlab.com/{{ gitlab_username }}" target="_blank" rel="noopener noreferrer">@{{ gitlab_username }}</a>
              </div>
            </li>
          {% endif %}

          {% if gpg_keys %}
            <li class="list-group-item">
              <strong class="profile-attr-label" title="GPG Keys"><i class="fas fa-key"></i> GPG Keys</strong>
              <div class="mt-2 profile-pre-list">
                {% for keyid in gpg_keys %}
                  <pre class="mb-1">{{ keyid }}</pre>
                {% endfor %}
              </div>
            </li>
          {% endif %}

          {% if ssh_keys %}
            <li class="list-group-item">
              <strong class="profile-attr-label" title="SSH Keys"><i class="fas fa-key"></i> SSH Keys</strong>
              <div class="mt-2 profile-pre-list">
                {% for key in ssh_keys %}
                  <pre class="mb-1">{{ key }}</pre>
                {% endfor %}
              </div>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>

    <div class="col-md-8">
      <ul class="list-group mb-3">
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <strong>Membership</strong>
          <div class="d-flex align-items-center" style="gap: .5rem;">
            {% if membership_can_view %}
              <a href="{% url 'membership-audit-log-user' fu.username %}" class="btn btn-sm btn-outline-secondary">History</a>
            {% endif %}
            {% if is_self %}
              {% if membership_can_request_any %}
                <a href="{{ membership_request_url }}" class="btn btn-sm btn-outline-primary">Request</a>
              {% else %}
                <a href="#" class="btn btn-sm btn-outline-primary disabled" aria-disabled="true" tabindex="-1" title="No additional membership types available">Request</a>
              {% endif %}
            {% endif %}
          </div>
        </li>

        {% for m in memberships %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">{{ m.membership_type.name }}</div>
              {% if m.is_expiring_soon %}
                <div class="text-danger small">
                  <i class="fas fa-exclamation-triangle mr-1"></i>
                  {% with tz=timezone_name|default:"UTC" %}
                    {% timezone tz %}
                      Expires {{ m.expires_at|date:"M j, Y H:i" }} ({{ tz }})
                    {% endtimezone %}
                  {% endwith %}
                </div>
              {% else %}
                <div class="text-muted small">
                  {% with tz=timezone_name|default:"UTC" %}
                    {% timezone tz %}
                      Expires {{ m.expires_at|date:"M j, Y" }}
                    {% endtimezone %}
                  {% endwith %}
                </div>
              {% endif %}
            </div>
            <div class="d-flex align-items-center justify-content-end flex-wrap" style="gap: .5rem;">
              {% if is_self and m.is_expiring_soon %}
                <a href="{{ m.extend_url }}" class="btn btn-sm btn-primary">Extend</a>
              {% else %}
                {% if membership_can_view and m.request_id %}
                  <a class="badge badge-success" href="{% url 'membership-request-detail' m.request_id %}">Active</a>
                {% else %}
                  <span class="badge badge-success">Active</span>
                {% endif %}
              {% endif %}

              {% if membership_can_change and membership_can_delete %}
                {% with counter_str=forloop.counter|stringformat:"s" %}
                  {% include 'core/_expiry_and_termination_actions.html' with user=fu membership=m id_suffix=counter_str %}
                {% endwith %}
              {% endif %}
            </div>
          </li>
        {% empty %}
          {% if not membership_pending_requests %}
            <li class="list-group-item text-muted">
              No memberships yet.
              {% if is_self and membership_can_request_any %}
                <a href="{{ membership_request_url }}">Request membership</a>
              {% endif %}
            </li>
          {% endif %}
        {% endfor %}

        {% for req in membership_pending_requests %}
          <li class="list-group-item d-flex justify-content-between align-items-center text-muted">
            <div>
              {% if is_self %}
                <div class="font-weight-bold">
                  <a href="{% url 'membership-request-self' req.request_id %}">{{ req.membership_type.name }}</a>
                </div>
              {% elif membership_can_view %}
                <div class="font-weight-bold">
                  <a href="{% url 'membership-request-detail' req.request_id %}">{{ req.membership_type.name }}</a>
                </div>
              {% else %}
                <div class="font-weight-bold">{{ req.membership_type.name }}</div>
              {% endif %}
            </div>
            {% if req.status == 'on_hold' %}
              {% if is_self %}
                <a class="badge badge-danger" href="{% url 'membership-request-self' req.request_id %}">Awaiting action</a>
              {% elif membership_can_view %}
                <a class="badge badge-danger" href="{% url 'membership-request-detail' req.request_id %}">On hold</a>
              {% else %}
                <span class="badge badge-danger">On hold</span>
              {% endif %}
            {% else %}
              {% if membership_can_view %}
                <a class="badge badge-secondary" href="{% url 'membership-request-detail' req.request_id %}">In Review</a>
              {% else %}
                <span class="badge badge-secondary">In Review</span>
              {% endif %}
            {% endif %}
          </li>
        {% endfor %}

        {% if membership_can_view %}
          {% membership_notes_aggregate_for_user fu.username compact=True %}
        {% endif %}
      </ul>

      <ul class="list-group profile-memberships">
        <li class="list-group-item profile-memberships-header text-right">
          <strong>
            {{ groups|length }} Group{{ groups|pluralize }}{% if agreements %}, {{ agreements|length }} Signed Agreement{{ agreements|pluralize }}{%endif%}{% if missing_agreements %}, {{ missing_agreements|length }} Missing Agreement{{ missing_agreements|pluralize }}{% endif %}
          </strong>
        </li>

        {% if groups or agreements or missing_agreements %}
          {% for a in missing_agreements %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle profile-group-icon"></i>
                <div class="profile-group-name">
                  {% if is_self and a.settings_url %}
                    <a href="{{ a.settings_url }}">{{ a.cn }}</a>
                  {% else %}
                    {{ a.cn }}
                  {% endif %}
                  {% if a.required_by %}
                    <div class="small text-muted">Required for: {{ a.required_by|join:", " }}</div>
                  {% endif %}
                </div>
              </div>
              <span class="badge badge-danger">Required</span>
            </li>
          {% endfor %}

          {% for a in agreements %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <i class="fa fa-check-circle profile-group-icon"></i>
                <div class="profile-group-name">{{ a }}</div>
              </div>
              <span class="badge badge-success">Signed</span>
            </li>
          {% endfor %}

          {% for g in groups %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <i class="fas fa-users profile-group-icon"></i>
                <div class="profile-group-name">
                  <a href="{% url 'group-detail' g.cn %}">{{ g.cn }}</a>
                </div>
              </div>
              {% if g.role == 'Sponsor' %}
                <span class="badge badge-primary">Sponsor</span>
              {% else %}
                <span class="badge badge-secondary">Member</span>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
          <li class="list-group-item text-muted text-center py-5">
            {{ fu.username }} has no group memberships
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
<script>
(function () {
  var tzNode = document.getElementById('user-timezone');
  var timeNode = document.getElementById('user-time');
  if (!tzNode || !timeNode) return;

  var tz = tzNode.getAttribute('data-timezone') || '';
  if (!tz) return;

  function updateTime() {
    try {
      var now = new Date();
      timeNode.textContent = now.toLocaleString(undefined, {
        timeZone: tz,
        weekday: 'long',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    } catch (e) {
      // If the browser doesn't support the timezone, keep the server-rendered time.
    }
  }

  updateTime();
  window.setInterval(updateTime, 1000);
})();
</script>
{% endblock %}
