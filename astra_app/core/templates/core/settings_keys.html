{% extends 'core/base.html' %}

{% block title %}Settings - Keys{% endblock %}

{% block header %}
  <h1 class="m-0">Settings for <a href="{% url 'profile' %}">{{ request.user.get_username }}</a></h1>
{% endblock %}

{% block content %}
<div class="settings-page">
  <div class="card card-primary card-tabs settings-card mt-3">
    <div class="card-header p-0 pt-1">
      {% include 'core/_settings_tabs.html' %}
    </div>
    <div class="card-body">
    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}

      <div class="form-group">
        <label>{{ form.fasGPGKeyId.label }}</label>

        <div id="gpg-keys-widget" class="d-none">
          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle mb-2" id="gpg-keys-table">
              <tbody></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="gpg-keys-add">Add GPG key ID</button>
        </div>

        <div id="gpg-keys-fallback">
          {{ form.fasGPGKeyId }}
          {% if form.fasGPGKeyId.help_text %}<small class="form-text text-muted">{{ form.fasGPGKeyId.help_text }}</small>{% endif %}
          {% if form.fasGPGKeyId.errors %}<div class="text-danger">{{ form.fasGPGKeyId.errors }}</div>{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label>{{ form.ipasshpubkey.label }}</label>

        <div id="ssh-keys-widget" class="d-none">
          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle mb-2" id="ssh-keys-table">
              <tbody></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="ssh-keys-add">Add SSH key</button>
        </div>

        <div id="ssh-keys-fallback">
          {{ form.ipasshpubkey }}
          {% if form.ipasshpubkey.help_text %}<small class="form-text text-muted">{{ form.ipasshpubkey.help_text }}</small>{% endif %}
          {% if form.ipasshpubkey.errors %}<div class="text-danger">{{ form.ipasshpubkey.errors }}</div>{% endif %}
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Save</button>
    </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}

  <script>
    (function () {
      function onReady(fn) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', fn);
        } else {
          fn();
        }
      }

      function setupRowEditor(opts) {
        const textarea = document.getElementById(opts.textareaId);
        const widget = document.getElementById(opts.widgetId);
        const fallback = document.getElementById(opts.fallbackId);
        const tableBody = document.querySelector(opts.tableBodySelector);
        const addBtn = document.getElementById(opts.addBtnId);

        if (!textarea || !widget || !fallback || !tableBody || !addBtn || !textarea.form) return;

        function buildRow(initialValue) {
          const tr = document.createElement('tr');
          tr.className = opts.rowClass;

          tr.innerHTML = `
            <td>
              ${opts.kind === 'textarea'
                ? '<textarea class="form-control form-control-sm text-monospace" rows="2" placeholder="Paste a key"></textarea>'
                : '<input type="text" class="form-control form-control-sm text-monospace" placeholder="Key ID" />'
              }
            </td>
            <td style="width: 44px;" class="text-center">
              <button type="button" class="btn btn-sm btn-outline-secondary" aria-label="Remove">Ã—</button>
            </td>
          `;

          const valueEl = tr.querySelector('input,textarea');
          const removeBtn = tr.querySelector('button');

          valueEl.value = initialValue || '';
          valueEl.addEventListener('input', syncToTextarea);
          removeBtn.addEventListener('click', function () {
            tr.remove();
            syncToTextarea();
          });

          return tr;
        }

        function syncToTextarea() {
          const rows = Array.from(tableBody.querySelectorAll('tr.' + opts.rowClass));
          const lines = [];
          for (const row of rows) {
            const valueEl = row.querySelector('input,textarea');
            const raw = (valueEl && valueEl.value) ? String(valueEl.value) : '';
            const v = raw.replaceAll('\r', '').trim();
            if (v) lines.push(v);
          }
          textarea.value = lines.join('\n');
        }

        function addRow(value) {
          const tr = buildRow(value);
          tableBody.appendChild(tr);
          syncToTextarea();
          return tr;
        }

        const existing = String(textarea.value || '')
          .replaceAll('\r', '')
          .split('\n')
          .map(function (l) { return String(l || '').trim(); })
          .filter(Boolean);

        if (existing.length === 0) {
          addRow('');
        } else {
          for (const v of existing) addRow(v);
        }

        addBtn.addEventListener('click', function () {
          const tr = addRow('');
          const input = tr.querySelector('input,textarea');
          if (input) input.focus();
        });

        textarea.form.addEventListener('submit', function () {
          syncToTextarea();
        });

        // Keep the fallback visible if there are server-side validation errors.
        const hasErrors = !!fallback.querySelector('.errorlist, .text-danger .errorlist');
        if (!hasErrors) {
          fallback.classList.add('d-none');
        }
        widget.classList.remove('d-none');
      }

      onReady(function () {
        setupRowEditor({
          textareaId: 'id_fasGPGKeyId',
          widgetId: 'gpg-keys-widget',
          fallbackId: 'gpg-keys-fallback',
          tableBodySelector: '#gpg-keys-table tbody',
          addBtnId: 'gpg-keys-add',
          rowClass: 'gpg-keys-row',
          kind: 'input'
        });

        setupRowEditor({
          textareaId: 'id_ipasshpubkey',
          widgetId: 'ssh-keys-widget',
          fallbackId: 'ssh-keys-fallback',
          tableBodySelector: '#ssh-keys-table tbody',
          addBtnId: 'ssh-keys-add',
          rowClass: 'ssh-keys-row',
          kind: 'textarea'
        });
      });
    })();
  </script>
{% endblock %}
