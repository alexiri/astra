{% extends 'core/base.html' %}

{% load static %}

{% block title %}Settings{% endblock %}

{% block header %}
  <h1 class="m-0">Settings for <a href="{% url 'user-profile' request.user.get_username %}">{{ request.user.get_username }}</a></h1>
{% endblock %}

{% block content %}
<div class="settings-page">
  <div class="card card-primary card-tabs settings-card mt-3">
    <div class="card-header p-0 pt-1">
      {% include 'core/_settings_tabs.html' %}
    </div>

    <form method="post" novalidate class="m-0">
      {% csrf_token %}

      <div class="card-body">
        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="alert alert-info">
          <strong>Optional:</strong> Use <em>Find address</em> to fill the form using the Photon (Komoot) geocoder.
          You can always edit the fields before saving.
        </div>

        <div class="form-group">
          <label for="address-query">Find address</label>
          <div class="position-relative">
            <div class="input-group">
            <input id="address-query" type="text" class="form-control" placeholder="e.g. Main St 5, Springfield" autocomplete="off" />
            <div class="input-group-append">
              <button type="button" class="btn btn-outline-secondary" id="address-find-btn">Find</button>
            </div>
          </div>
            <div id="address-suggest" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
          </div>
          <small class="form-text text-muted">Queries https://photon.komoot.io. If no result is found, nothing is changed.</small>
          <div id="address-find-status" class="mt-2"></div>
        </div>

        <div class="form-group">
          {{ form.street.label_tag }}
          {{ form.street }}
          {% if form.street.errors %}<div class="invalid-feedback d-block">{{ form.street.errors }}</div>{% endif %}
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            {{ form.l.label_tag }}
            {{ form.l }}
            {% if form.l.errors %}<div class="invalid-feedback d-block">{{ form.l.errors }}</div>{% endif %}
          </div>
          <div class="form-group col-md-6">
            {{ form.st.label_tag }}
            {{ form.st }}
            {% if form.st.errors %}<div class="invalid-feedback d-block">{{ form.st.errors }}</div>{% endif %}
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            {{ form.postalcode.label_tag }}
            {{ form.postalcode }}
            {% if form.postalcode.errors %}<div class="invalid-feedback d-block">{{ form.postalcode.errors }}</div>{% endif %}
          </div>
          <div class="form-group col-md-6">
            {{ form.c.label_tag }}
            {{ form.c }}
            {% if form.c.errors %}<div class="invalid-feedback d-block">{{ form.c.errors }}</div>{% endif %}
            {% if form.c.help_text %}<small class="form-text text-muted">{{ form.c.help_text }}</small>{% endif %}
          </div>
        </div>
      </div>

      <div class="card-footer d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}

  <script>
    (function () {
      function $(id) { return document.getElementById(id); }

      const queryEl = $('address-query');
      const btn = $('address-find-btn');
      const status = $('address-find-status');
      const suggest = $('address-suggest');

      const streetEl = $("{{ form.street.id_for_label }}");
      const cityEl = $("{{ form.l.id_for_label }}");
      const stateEl = $("{{ form.st.id_for_label }}");
      const postalEl = $("{{ form.postalcode.id_for_label }}");
      const countryEl = $("{{ form.c.id_for_label }}");

      if (!queryEl || !btn || !status) return;

      let lastSuggestRequest = 0;
      let suggestTimer = null;
      let currentOptions = [];
      let activeIndex = -1;

      if (suggest) {
        suggest.setAttribute('role', 'listbox');
      }
      queryEl.setAttribute('aria-autocomplete', 'list');
      queryEl.setAttribute('aria-expanded', 'false');
      if (suggest && suggest.id) {
        queryEl.setAttribute('aria-controls', suggest.id);
      }

      function hideSuggest() {
        if (!suggest) return;
        suggest.innerHTML = '';
        suggest.style.display = 'none';
        queryEl.setAttribute('aria-expanded', 'false');
        currentOptions = [];
        activeIndex = -1;
      }

      function isSuggestVisible() {
        return Boolean(suggest && suggest.style.display !== 'none');
      }

      function setActiveIndex(nextIndex) {
        if (!suggest) return;
        const buttons = suggest.querySelectorAll('button');
        if (!buttons || !buttons.length) {
          activeIndex = -1;
          return;
        }

        const maxIndex = buttons.length - 1;
        const i = Math.max(0, Math.min(maxIndex, nextIndex));
        activeIndex = i;

        for (let idx = 0; idx < buttons.length; idx++) {
          const b = buttons[idx];
          const isActive = idx === activeIndex;
          if (isActive) {
            b.classList.add('active');
            b.setAttribute('aria-selected', 'true');
            b.scrollIntoView({ block: 'nearest' });
          } else {
            b.classList.remove('active');
            b.setAttribute('aria-selected', 'false');
          }
        }
      }

      function applySuggestion(opt) {
        if (!opt) return;
        if (streetEl && opt.street) streetEl.value = opt.street;
        if (cityEl && opt.l) cityEl.value = opt.l;
        if (stateEl && opt.st) stateEl.value = opt.st;
        if (postalEl && opt.postalcode) postalEl.value = opt.postalcode;
        if (countryEl && opt.c) countryEl.value = opt.c;
        queryEl.value = opt.label || queryEl.value;
        hideSuggest();
        setStatus('info', 'Filled from Photon. Review and click Save.');
      }

      function showSuggestOptions(options) {
        if (!suggest) return;
        suggest.innerHTML = '';
        if (!options || !options.length) {
          hideSuggest();
          return;
        }

        currentOptions = options;
        activeIndex = -1;

        for (const opt of options) {
          const a = document.createElement('button');
          a.type = 'button';
          a.className = 'list-group-item list-group-item-action';
          a.textContent = opt.label || opt.street || 'Suggestion';
          a.setAttribute('role', 'option');
          a.setAttribute('aria-selected', 'false');
          a.addEventListener('click', function () {
            applySuggestion(opt);
          });

          a.addEventListener('mousemove', function () {
            const buttons = suggest.querySelectorAll('button');
            const idx = Array.prototype.indexOf.call(buttons, a);
            if (idx >= 0) setActiveIndex(idx);
          });
          suggest.appendChild(a);
        }

        suggest.style.display = 'block';
        queryEl.setAttribute('aria-expanded', 'true');
      }

      function requestSuggest() {
        const q = (queryEl.value || '').trim();
        if (!q || q.length < 3) {
          hideSuggest();
          return;
        }

        const requestId = ++lastSuggestRequest;
        fetch("{% url 'settings-address-suggest' %}?q=" + encodeURIComponent(q), { credentials: 'same-origin' })
          .then(function (resp) { return resp.json(); })
          .then(function (data) {
            if (requestId !== lastSuggestRequest) return;
            showSuggestOptions((data && data.options) || []);
          })
          .catch(function () {
            if (requestId !== lastSuggestRequest) return;
            hideSuggest();
          });
      }

      queryEl.addEventListener('input', function () {
        if (suggestTimer) window.clearTimeout(suggestTimer);
        suggestTimer = window.setTimeout(requestSuggest, 250);
        activeIndex = -1;
      });

      queryEl.addEventListener('keydown', function (evt) {
        const key = evt.key;
        const visible = isSuggestVisible();
        const hasOptions = Boolean(currentOptions && currentOptions.length);

        if (key === 'Escape' && visible) {
          evt.preventDefault();
          hideSuggest();
          return;
        }

        if (key === 'ArrowDown') {
          if (visible && hasOptions) {
            evt.preventDefault();
            if (activeIndex < 0) {
              setActiveIndex(0);
            } else {
              setActiveIndex((activeIndex + 1) % currentOptions.length);
            }
            return;
          }
          return;
        }

        if (key === 'ArrowUp') {
          if (visible && hasOptions) {
            evt.preventDefault();
            if (activeIndex < 0) {
              setActiveIndex(currentOptions.length - 1);
            } else {
              setActiveIndex((activeIndex - 1 + currentOptions.length) % currentOptions.length);
            }
            return;
          }
          return;
        }

        if (key === 'Enter' && visible && hasOptions) {
          evt.preventDefault();
          const idx = activeIndex >= 0 ? activeIndex : 0;
          applySuggestion(currentOptions[idx]);
        }
      });

      document.addEventListener('click', function (evt) {
        if (!suggest || suggest.style.display === 'none') return;
        if (evt.target === queryEl || suggest.contains(evt.target)) return;
        hideSuggest();
      });

      function setStatus(kind, text) {
        status.className = '';
        if (!text) { status.innerHTML = ''; return; }
        const cls = kind === 'error' ? 'alert-danger' : (kind === 'info' ? 'alert-info' : 'alert-warning');
        status.innerHTML = '<div class="alert ' + cls + ' py-2 mb-0">' + text + '</div>';
      }

      function defaultQuery() {
        const parts = [];
        if (streetEl && streetEl.value) parts.push(streetEl.value);
        if (cityEl && cityEl.value) parts.push(cityEl.value);
        if (stateEl && stateEl.value) parts.push(stateEl.value);
        if (postalEl && postalEl.value) parts.push(postalEl.value);
        if (countryEl && countryEl.value) parts.push(countryEl.value);
        return parts.join(', ');
      }

      btn.addEventListener('click', function () {
        const q = (queryEl.value || '').trim() || defaultQuery();
        if (!q) {
          setStatus('warning', 'Enter an address to search.');
          return;
        }

        hideSuggest();

        setStatus('info', 'Searchingâ€¦');
        btn.disabled = true;

        fetch("{% url 'settings-address-lookup' %}?q=" + encodeURIComponent(q), { credentials: 'same-origin' })
          .then(function (resp) { return resp.json(); })
          .then(function (data) {
            if (!data || !data.found) {
              setStatus('warning', 'No result found.');
              return;
            }

            if (streetEl && data.street) streetEl.value = data.street;
            if (cityEl && data.l) cityEl.value = data.l;
            if (stateEl && data.st) stateEl.value = data.st;
            if (postalEl && data.postalcode) postalEl.value = data.postalcode;
            if (countryEl && data.c) countryEl.value = data.c;

            setStatus('info', 'Filled from Photon. Review and click Save.');
          })
          .catch(function () {
            setStatus('error', 'Lookup failed. You can fill the address manually.');
          })
          .finally(function () {
            btn.disabled = false;
          });
      });
    })();
  </script>
{% endblock %}
