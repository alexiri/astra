{% load static %}
{% load avatar_tags %}
{% load tz %}

  <div
    id="membership-notes-container-{{ membership_request.pk }}"
    data-membership-notes-container="{{ membership_request.pk }}"
    data-membership-notes-default-open="{% if compact %}0{% else %}1{% endif %}"
  >
    <style>
      /* Scoped per widget to avoid affecting other direct-chat blocks. */
      #membership-notes-container-{{ membership_request.pk }} .direct-chat-text {
        display: inline-block;
        width: auto;
        max-width: 80%;
        overflow-wrap: anywhere;
      }

      /*
       * Compact header: title on the left (ellipsis if needed), tools on the right.
       * Keep everything on a single row.
       */
      #membership-notes-container-{{ membership_request.pk }} .membership-notes-header-compact {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .5rem;
      }

      #membership-notes-container-{{ membership_request.pk }} .membership-notes-title {
        min-width: 0;
      }

      #membership-notes-container-{{ membership_request.pk }} .membership-notes-header-compact .membership-notes-title {
        margin: 0;
        flex: 1 1 auto;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      #membership-notes-container-{{ membership_request.pk }} .membership-notes-header-compact .card-tools {
        float: none;
        flex: 0 0 auto;
        margin-left: auto;
        display: flex;
        align-items: center;
        flex-wrap: nowrap;
        white-space: nowrap;
        gap: .25rem;
      }

      #membership-notes-container-{{ membership_request.pk }} .membership-notes-bubble {
        background-color: var(--bubble-bg) !important;
        color: var(--bubble-fg, #212529) !important;
      }

      /* Make the little arrow/triangle match the border color. */
      #membership-notes-container-{{ membership_request.pk }} .direct-chat-msg.right .membership-notes-bubble::before,
      #membership-notes-container-{{ membership_request.pk }} .direct-chat-msg.right .membership-notes-bubble::after {
        border-left-color: #d2d6de !important;
        border-right-color: transparent !important;
      }

      #membership-notes-container-{{ membership_request.pk }} .direct-chat-msg.right {
        text-align: right;
      }

      #membership-notes-container-{{ membership_request.pk }} .direct-chat-msg.right .direct-chat-text {
        margin-left: auto;
        margin-right: 10px;
        text-align: right;
      }

      #membership-notes-container-{{ membership_request.pk }} .direct-chat-msg:not(.right) .direct-chat-text {
        margin-left: 10px;
        margin-right: auto;
      }
    </style>

    <div
      id="membership-notes-card-{{ membership_request.pk }}"
      class="card card-primary card-outline direct-chat direct-chat-primary mb-0{% if compact %} collapsed-card{% endif %}"
      data-membership-notes-card="{{ membership_request.pk }}"
    >
      <div
        class="card-header{% if compact %} membership-notes-header-compact{% endif %}"
        data-membership-notes-header="{{ membership_request.pk }}"
        role="button"
        tabindex="0"
        aria-label="Toggle membership notes"
        style="cursor: pointer;"
      >
        <h3
          class="card-title membership-notes-title {% if compact %}text-sm text-truncate{% endif %}"
        >
          Membership Committee Notes
        </h3>
        <div class="card-tools">
          <span
            data-toggle="tooltip"
            title="{{ note_count }} Messages"
            class="badge badge-primary"
            data-membership-notes-count="{{ membership_request.pk }}"
          >{{ note_count }}</span>
          <span class="badge badge-success" title="Approvals" data-membership-notes-approvals="{{ membership_request.pk }}">
            <i class="fas fa-thumbs-up"></i> {{ approvals }}
          </span>
          <span class="badge badge-danger" title="Disapprovals" data-membership-notes-disapprovals="{{ membership_request.pk }}">
            <i class="fas fa-thumbs-down"></i> {{ disapprovals }}
          </span>
          <button
            type="button"
            class="btn btn-tool"
            data-card-widget="collapse"
            aria-label="Collapse"
            data-membership-notes-collapse="{{ membership_request.pk }}"
          >
            <i class="fas {% if compact %}fa-plus{% else %}fa-minus{% endif %}"></i>
          </button>
        </div>
      </div>

      <div class="card-body">
        <div
          class="direct-chat-messages"
          data-membership-notes-messages="{{ membership_request.pk }}"
          {% if compact %} style="max-height: 260px;"{% endif %}
        >
          {% for entry in entries %}
            <div class="direct-chat-msg {% if not forloop.last %}mb-3{% endif %} {% if entry.is_self %} right{% endif %}">
              <div class="direct-chat-infos clearfix">
                {% if entry.is_self %}
                  <span class="direct-chat-name float-right">{{ entry.note.username }}</span>
                  <span class="direct-chat-timestamp float-left">
                    {{ entry.note.timestamp|localtime|date:"DATETIME_FORMAT" }}
                    {% if entry.membership_request_id and entry.membership_request_url %}
                      <a href="{{ entry.membership_request_url }}" class="text-muted ml-1">(req. #{{ entry.membership_request_id }})</a>
                    {% endif %}
                  </span>
                {% else %}
                  <span class="direct-chat-name float-left">{{ entry.note.username }}</span>
                  <span class="direct-chat-timestamp float-right">
                    {% if entry.membership_request_id and entry.membership_request_url %}
                      <a href="{{ entry.membership_request_url }}" class="text-muted mr-1">(req. #{{ entry.membership_request_id }})</a>
                    {% endif %}
                    {{ entry.note.timestamp|localtime|date:"DATETIME_FORMAT" }}
                  </span>
                {% endif %}
              </div>

              {% if entry.avatar_user %}
                {% avatar entry.avatar_user 40 class="direct-chat-img img-circle" style="object-fit:cover;" alt="Avatar" %}
              {% else %}
                <img class="direct-chat-img" src="{% static 'core/images/almalinux-logo.svg' %}" alt="user image">
              {% endif %}

              {% if entry.kind == 'action' %}
                <div
                  class="direct-chat-text bg-light membership-notes-bubble"
                  style="{{ entry.bubble_style }} border: 1px dashed rgba(0,0,0,0.15);"
                >
                  <i class="fas {{ entry.icon|default:"fa-bolt" }} mr-1"></i> {{ entry.label }}
                </div>
              {% else %}
                {% if not entry.is_self and entry.bubble_style %}
                  <div class="direct-chat-text membership-notes-bubble" style="{{ entry.bubble_style }}">
                    {{ entry.note.content }}
                  </div>
                {% else %}
                  <div class="direct-chat-text">
                    {{ entry.note.content }}
                  </div>
                {% endif %}
              {% endif %}
            </div>
          {% empty %}
            <div class="text-muted small">No notes yet.</div>
          {% endfor %}
        </div>
      </div>

      {% if can_post %}
        <div class="card-footer">
          <div
            id="membership-notes-error-{{ membership_request.pk }}"
            class="alert alert-danger py-2 px-3 mb-2 d-none"
            role="alert"
            aria-live="polite"
          >
            <div class="d-flex align-items-start justify-content-between" style="gap: .75rem;">
              <div id="membership-notes-error-text-{{ membership_request.pk }}"></div>
              <button
                type="button"
                class="close"
                aria-label="Dismiss"
                data-membership-notes-error-close="{{ membership_request.pk }}"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </div>
          <form
            id="membership-notes-form-{{ membership_request.pk }}"
            method="post"
            action="{% url 'membership-request-note-add' membership_request.pk %}"
            data-membership-notes-form="{{ membership_request.pk }}"
          >
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ next_url }}">
            <input type="hidden" name="note_action" value="message">
            <div class="input-group">
              <textarea
                id="membership-notes-message-{{ membership_request.pk }}"
                name="message"
                placeholder="Type a note..."
                class="form-control"
                rows="2"
              ></textarea>
              <div class="input-group-append">
                {% if compact %}
                  <button
                    type="submit"
                    class="btn btn-light border"
                    title="Send (Ctrl+Enter)"
                    aria-label="Send note"
                  >
                    <i class="fas fa-paper-plane"></i>
                  </button>
                {% else %}
                  <div class="btn-group" role="group" aria-label="Note actions">
                    <button
                      type="submit"
                      class="btn btn-light border"
                      title="Send (Ctrl+Enter)"
                      aria-label="Send note"
                    >
                      <i class="fas fa-paper-plane mr-1"></i> Send
                    </button>
                    <button
                      type="button"
                      class="btn btn-light border"
                      data-note-action="vote_approve"
                      title="Vote approve"
                      aria-label="Vote approve"
                    >
                      <i class="fas fa-thumbs-up text-success"></i>
                    </button>
                    <button
                      type="button"
                      class="btn btn-light border"
                      data-note-action="vote_disapprove"
                      title="Vote disapprove"
                      aria-label="Vote disapprove"
                    >
                      <i class="fas fa-thumbs-down text-danger"></i>
                    </button>
                  </div>
                {% endif %}
              </div>
            </div>

            {% if compact %}
              <div class="d-flex w-100 mt-1" role="group" aria-label="Vote actions">
                <button
                  type="button"
                  class="btn btn-light border btn-sm flex-fill py-1"
                  data-note-action="vote_approve"
                  title="Vote approve"
                  aria-label="Vote approve"
                >
                  <i class="fas fa-thumbs-up text-success"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-light border btn-sm flex-fill py-1"
                  data-note-action="vote_disapprove"
                  title="Vote disapprove"
                  aria-label="Vote disapprove"
                >
                  <i class="fas fa-thumbs-down text-danger"></i>
                </button>
              </div>
            {% endif %}
          </form>
        </div>
      {% endif %}
    </div>

    <script>
      (function () {
        var pk = '{{ membership_request.pk }}';
        if (!pk) return;

        window.AstraMembershipNotes = window.AstraMembershipNotes || {};

        window.AstraMembershipNotes._storageKey = function (requestPk) {
          return 'membership_notes_open_' + requestPk;
        };

        window.AstraMembershipNotes.init = window.AstraMembershipNotes.init || function (requestPk) {
          var container = document.getElementById('membership-notes-container-' + requestPk);
          if (!container || container.dataset.membershipNotesInitialized) return;
          container.dataset.membershipNotesInitialized = '1';

          var card = document.getElementById('membership-notes-card-' + requestPk);
          var form = document.getElementById('membership-notes-form-' + requestPk);
          var message = document.getElementById('membership-notes-message-' + requestPk);
          var collapseBtn = container.querySelector('[data-membership-notes-collapse="' + requestPk + '"]');
          var header = container.querySelector('[data-membership-notes-header="' + requestPk + '"]');

          function getMessagesEl() {
            return container.querySelector('[data-membership-notes-messages="' + requestPk + '"]');
          }

          function setOpenState(isOpen) {
            try {
              window.localStorage.setItem(window.AstraMembershipNotes._storageKey(requestPk), isOpen ? '1' : '0');
            } catch (e) {
              // Ignore storage errors.
            }
          }

          function readStoredOpenState() {
            try {
              return window.localStorage.getItem(window.AstraMembershipNotes._storageKey(requestPk));
            } catch (e) {
              return null;
            }
          }

          function getDesiredOpenState() {
            var stored = readStoredOpenState();
            if (stored === '1') return true;
            if (stored === '0') return false;
            return (container && container.dataset && container.dataset.membershipNotesDefaultOpen === '1');
          }

          function ensureDesiredOpenState() {
            if (!card || !collapseBtn) return;
            var desiredOpen = getDesiredOpenState();
            var isCollapsed = card.classList.contains('collapsed-card');

            if (desiredOpen && isCollapsed) {
              collapseBtn.click();
              scrollToBottomSoon();
            } else if (!desiredOpen && !isCollapsed) {
              collapseBtn.click();
            }
          }

          function scrollToBottom() {
            var msgs = getMessagesEl();
            if (!msgs) return;
            msgs.scrollTop = msgs.scrollHeight;
          }

          function scrollToBottomWhenReady(maxWaitMs) {
            if (!card) {
              scrollToBottom();
              return;
            }

            var start = Date.now();

            function tick() {
              var msgs = getMessagesEl();
              if (!msgs) return;

              var isOpen = !card.classList.contains('collapsed-card');
              var isVisible = msgs.clientHeight > 0;

              if (isOpen && isVisible) {
                msgs.scrollTop = msgs.scrollHeight;
                setTimeout(function () {
                  var msgs2 = getMessagesEl();
                  if (msgs2) msgs2.scrollTop = msgs2.scrollHeight;
                }, 0);
                return;
              }

              if (Date.now() - start > maxWaitMs) {
                msgs.scrollTop = msgs.scrollHeight;
                return;
              }

              setTimeout(tick, 50);
            }

            tick();
          }

          function scrollToBottomSoon() {
            scrollToBottom();
            // Expand uses an animation (~1s); wait until the element is measurable.
            scrollToBottomWhenReady(2000);
          }

          function ajaxSubmit(action) {
            if (!form) return;
            setOpenState(true);
            ensureDesiredOpenState();

            var errorBox = document.getElementById('membership-notes-error-' + requestPk);
            var errorText = document.getElementById('membership-notes-error-text-' + requestPk);
            if (errorBox) {
              errorBox.classList.add('d-none');
            }
            if (errorText) {
              errorText.textContent = '';
            }

            var actionInput = form.querySelector('input[name="note_action"]');
            if (actionInput) actionInput.value = action;

            var formData = new FormData(form);
            formData.set('note_action', action);

            var buttons = form.querySelectorAll('button');
            for (var i = 0; i < buttons.length; i++) buttons[i].disabled = true;

            fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              },
              credentials: 'same-origin'
            })
              .then(function (resp) {
                return resp.json().then(function (data) {
                  return { status: resp.status, data: data };
                });
              })
              .then(function (result) {
                if (!result || !result.data || !result.data.ok || !result.data.html) {
                  throw new Error((result && result.data && result.data.error) || 'Failed');
                }

                var currentContainer = document.getElementById('membership-notes-container-' + requestPk);
                if (!currentContainer) return;

                var tmp = document.createElement('div');
                tmp.innerHTML = result.data.html;
                var newContainer = tmp.querySelector('#membership-notes-container-' + requestPk);
                if (!newContainer) return;

                var newMessages = newContainer.querySelector('[data-membership-notes-messages="' + requestPk + '"]');
                var currentMessages = getMessagesEl();
                if (currentMessages && newMessages) {
                  currentMessages.innerHTML = newMessages.innerHTML;
                }

                var newCount = newContainer.querySelector('[data-membership-notes-count="' + requestPk + '"]');
                var curCounts = currentContainer.querySelectorAll('[data-membership-notes-count="' + requestPk + '"]');
                if (newCount && curCounts && curCounts.length) {
                  for (var cIdx = 0; cIdx < curCounts.length; cIdx++) {
                    curCounts[cIdx].textContent = newCount.textContent;
                    curCounts[cIdx].setAttribute('title', newCount.getAttribute('title') || '');
                  }
                }

                var newApprovals = newContainer.querySelector('[data-membership-notes-approvals="' + requestPk + '"]');
                var curApprovals = currentContainer.querySelectorAll('[data-membership-notes-approvals="' + requestPk + '"]');
                if (newApprovals && curApprovals && curApprovals.length) {
                  for (var aIdx = 0; aIdx < curApprovals.length; aIdx++) {
                    curApprovals[aIdx].innerHTML = newApprovals.innerHTML;
                  }
                }

                var newDisapprovals = newContainer.querySelector('[data-membership-notes-disapprovals="' + requestPk + '"]');
                var curDisapprovals = currentContainer.querySelectorAll('[data-membership-notes-disapprovals="' + requestPk + '"]');
                if (newDisapprovals && curDisapprovals && curDisapprovals.length) {
                  for (var dIdx = 0; dIdx < curDisapprovals.length; dIdx++) {
                    curDisapprovals[dIdx].innerHTML = newDisapprovals.innerHTML;
                  }
                }

                if (message) {
                  message.value = '';
                }
                scrollToBottomSoon();
              })
              .catch(function (err) {
                var box = document.getElementById('membership-notes-error-' + requestPk);
                var text = document.getElementById('membership-notes-error-text-' + requestPk);
                if (box) {
                  var msg = (err && err.message) ? String(err.message) : '';
                  if (!msg || msg === 'Failed') {
                    msg = 'Could not post note right now. Please try again.';
                  }
                  if (text) {
                    text.textContent = msg;
                  }
                  box.classList.remove('d-none');
                }
              })
              .finally(function () {
                var btns = form.querySelectorAll('button');
                for (var j = 0; j < btns.length; j++) btns[j].disabled = false;
              });
          }

          if (collapseBtn && card) {
            // Prefer AdminLTE CardWidget events when available.
            card.addEventListener('expanded.lte.cardwidget', function () {
              setOpenState(true);
              scrollToBottomSoon();
            });
            card.addEventListener('collapsed.lte.cardwidget', function () {
              setOpenState(false);
            });

            collapseBtn.addEventListener('click', function () {
              var wasCollapsed = card.classList.contains('collapsed-card');
              setTimeout(function () {
                var isOpen = !card.classList.contains('collapsed-card');
                setOpenState(isOpen);
                if (wasCollapsed && isOpen) {
                  // Fallback when the custom events aren't fired.
                  scrollToBottomSoon();
                }
              }, 0);
            });
          }

          if (header && collapseBtn) {
            header.addEventListener('click', function (e) {
              if (!e) return;
              // Don't double-toggle when clicking the card tools (plus button, badges).
              var t = e.target;
              if (t && t.closest && t.closest('.card-tools')) return;
              var wasCollapsed = card && card.classList.contains('collapsed-card');
              collapseBtn.click();
              if (wasCollapsed) scrollToBottomSoon();
            });

            header.addEventListener('keydown', function (e) {
              if (!e) return;
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                var wasCollapsed2 = card && card.classList.contains('collapsed-card');
                collapseBtn.click();
                if (wasCollapsed2) scrollToBottomSoon();
              }
            });
          }

          if (form) {
            form.addEventListener('submit', function (e) {
              if (!e) return;
              e.preventDefault();
              ajaxSubmit('message');
            });

            var voteButtons = form.querySelectorAll('[data-note-action]');
            for (var i2 = 0; i2 < voteButtons.length; i2++) {
              voteButtons[i2].addEventListener('click', function (e) {
                if (!e || !e.currentTarget) return;
                var action = e.currentTarget.getAttribute('data-note-action') || 'message';
                ajaxSubmit(action);
              });
            }
          }

          if (message) {
            message.addEventListener('keydown', function (e) {
              if (!e) return;
              if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                ajaxSubmit('message');
              }
            });
          }

          var errorClose = container.querySelector('[data-membership-notes-error-close="' + requestPk + '"]');
          if (errorClose) {
            errorClose.addEventListener('click', function () {
              var box = document.getElementById('membership-notes-error-' + requestPk);
              var text = document.getElementById('membership-notes-error-text-' + requestPk);
              if (text) text.textContent = '';
              if (box) box.classList.add('d-none');
            });
          }

          ensureDesiredOpenState();
          scrollToBottomSoon();
        };

        window.AstraMembershipNotes.init(pk);
      })();
    </script>
  </div>
