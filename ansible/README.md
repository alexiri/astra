# Ansible Playbooks for Astra

## FreeIPA Setup

### Prerequisites

- Ansible 2.9+ installed locally
- SSH access to target hosts
- Python 3.x on target hosts

### Running the FreeIPA Playbook

The playbook is automatically executed by Terraform after instance provisioning.

**Manual execution:**

```bash
# From workspace root
cd ansible

# Using Terraform-generated inventory
ansible-playbook -i ../infra/envs/dev/ipa_inventory.ini freeipa_setup.yml

# With extra verbosity
ansible-playbook -i ../infra/envs/dev/ipa_inventory.ini freeipa_setup.yml -vvv
```

### What the Playbook Does

1. Updates system packages
2. Installs FreeIPA server with DNS
3. Runs `ipa-server-install` in unattended mode
4. Installs FAS extensions from `fedora-infra/freeipa-fas`
5. Verifies FAS commands are available
6. Populates test data:
   - FAS agreements (FPCA)
   - FAS groups (developers, designers, elections, etc.)
   - 20 test users with FAS attributes
   - Member managers (sponsors)
7. Creates service account for application LDAP binding
8. Downloads IPA CA certificate to `ansible/ipa_ca.crt`

### Variables

Variables are passed via inventory file (generated by Terraform):

- `ipa_realm`: Kerberos realm (e.g., `ASTRA-DEV.TEST`)
- `ipa_domain`: IPA domain (e.g., `astra-dev.test`)
- `ipa_admin_password`: Admin password
- `ipa_dm_password`: Directory Manager password
- `ipa_hostname`: Fully qualified hostname

Additional variables can be passed via `-e`:

```bash
ansible-playbook -i inventory.ini freeipa_setup.yml \
  -e freeipa_service_username=myservice \
  -e freeipa_service_password=mypass
```

### Outputs

After successful execution:

- **IPA CA cert:** Downloaded to `ansible/ipa_ca.crt`
- **Service account:** Created with read-only LDAP permissions
- **Test users:** 20 users, all with password `password`
- **Web UI:** Available at `https://<hostname>/`

### Troubleshooting

**Playbook fails during ipa-server-install:**
- Check instance has at least 2 GB RAM (`t3.medium` recommended)
- Verify hostname is properly set and resolvable
- Check logs: `ssh fedora@<host> sudo cat /var/log/ipaserver-install.log`

**FAS extensions not loading:**
- Verify git clone succeeded
- Check Python package installed: `python3 -c "import ipaserver.plugins.fasagreement"`
- Restart IPA: `sudo ipactl restart`
- Verify: `ipa fasagreement-help`

**Service account creation fails:**
- Ensure Kerberos ticket is valid (playbook runs `kinit admin`)
- Check IPA is fully started: `sudo ipactl status`
- Check admin password is correct

### Idempotency

The playbook is designed to be idempotent:
- Skips `ipa-server-install` if already installed
- Uses `suppress(DuplicateEntry)` in Python for test data
- Service account creation checks for "already exists" errors

Safe to rerun without destroying existing data.
