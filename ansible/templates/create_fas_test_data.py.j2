#!/usr/bin/env python3
"""
FAS Test Data Population Script
Based on tiny-stage create_dummy_data.py, simplified for dev
"""

from contextlib import suppress, contextmanager
from faker import Faker
import python_freeipa

# Configuration from tiny-stage
USER_PASSWORD = "password"
PASSWORD_NEVER_EXPIRES_UNTIL: str = "20380119031407Z"
fake = Faker()
fake.seed_instance(0)

# IPA connection details (from Ansible vars)
IPA_HOST = "{{ ipa_hostname }}"
IPA_ADMIN_USER = "admin"
IPA_ADMIN_PASSWORD = "{{ ipa_admin_password }}"
CA_CERT_PATH = "/etc/ipa/ca.crt"


def rando(percentage: int) -> bool:
    """Random percentage check"""
    return fake.random_int(min=0, max=100, step=1) < percentage


@contextmanager
def handle_already_a_member():
    """Handle duplicate membership gracefully"""
    try:
        yield
    except python_freeipa.exceptions.ValidationError as e:
        if e.args[0]["member"]["user"][0][1] == "This entry is already a member":
            pass
        else:
            raise


# Test groups from tiny-stage
groups = {
    "developers": 80,
    "designers": 30,
    "elections": 10,
    "sysadmin-calendar": 10,
    "infra": 20,
    "QA": 20,
    "translators": 10,
    "ambassadors": 30,
}

# Connect to IPA
print(f"Connecting to IPA at {IPA_HOST}...")
ipa = python_freeipa.ClientLegacy(
    host=IPA_HOST,
    verify_ssl=CA_CERT_PATH
)
ipa.login(IPA_ADMIN_USER, IPA_ADMIN_PASSWORD)

# Create a separate connection for password changes
untouched_ipa = python_freeipa.ClientLegacy(
    host=IPA_HOST,
    verify_ssl=CA_CERT_PATH
)

# Create FAS agreement (FPCA)
agreement_name = "FPCA"
group_name = f"signed_{agreement_name}"

print(f"Creating FAS agreement: {agreement_name}")
with suppress(python_freeipa.exceptions.DuplicateEntry):
    ipa._request("fasagreement_add", agreement_name, {
        "description": f"This is the {agreement_name} agreement"
    })
    ipa.group_add(group_name, f"Signers of the {agreement_name}")
    ipa._request("automember_add", group_name, {"type": "group"})
    ipa._request("automember_add_condition", group_name, {
        "type": "group",
        "key": "memberof",
        "automemberinclusiveregex": f"^cn={agreement_name},cn=fasagreements,"
    })

# Create FAS groups
for group in groups.keys():
    print(f"Creating FAS group: {group}")
    with suppress(python_freeipa.exceptions.DuplicateEntry):
        ipa.group_add(group, f"A group for {group}", fasgroup=True)
        ipa._request("fasagreement_add_group", agreement_name, {"group": group})

# Create general group
with suppress(python_freeipa.exceptions.DuplicateEntry):
    ipa.group_add("general", "A group for general stuff", fasgroup=True)

# Create test users (20 users for dev, not 100)
num_users = 20
print(f"Creating {num_users} test users...")

for x in range(num_users):
    first_name = fake.first_name()
    last_name = fake.last_name()
    username = first_name + last_name
    fullname = first_name + " " + last_name

    print(f"Adding user {username} - {fullname}")
    with suppress(python_freeipa.exceptions.DuplicateEntry):
        ipa.user_add(
            username,
            first_name,
            last_name,
            fullname,
            disabled=False,
            user_password=USER_PASSWORD,
            fasircnick=[username, username + "_"],
            faslocale="en-US",
            fastimezone="UTC",
            # In dev, SELF_SERVICE_ADDRESS_COUNTRY_ATTR defaults to fasstatusnote.
            # Use a valid ISO 3166-1 alpha-2 code so the app isn't blocked by compliance gating.
            fasstatusnote="US",
            fasgpgkeyid=[],
        )

        # Set password (required for initial setup)
        untouched_ipa.change_password(
            username,
            new_password=USER_PASSWORD,
            old_password=USER_PASSWORD
        )

        # Avoid immediate PasswordExpired failures for freshly-created users.
        ipa.user_mod(username, setattr=[f"krbPasswordExpiration={PASSWORD_NEVER_EXPIRES_UNTIL}"])

    # Sign FPCA or add to general group
    with handle_already_a_member():
        has_signed_fpca = False
        if rando(90):  # 90% sign FPCA
            ipa._request("fasagreement_add_user", "FPCA", {"user": username})
            has_signed_fpca = True
        else:
            ipa.group_add_member("general", username)

    # Add to groups based on percentage
    for groupname, chance in groups.items():
        if rando(chance) and has_signed_fpca:
            with handle_already_a_member():
                ipa.group_add_member(groupname, username)
                # Add member manager (sponsor) 30% of the time
                if rando(30):
                    ipa._request(
                        "group_add_member_manager",
                        groupname,
                        {"user": username}
                    )

print("FAS test data population complete!")
print(f"Created {num_users} users, all with password: {USER_PASSWORD}")
print("Admin access: https://{}/ipa".format(IPA_HOST))
